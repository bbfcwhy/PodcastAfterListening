# Feature Specification: Tags 功能完善

**Feature Branch**: `010-tags-complete`
**Created**: 2026-02-25
**Status**: Draft
**Input**: User description: "現在Tags的功能似乎不太完整，請幫我規劃"

## Clarifications

### Session 2026-02-25

- Q: 每個單集最多可以指派幾個標籤？ → A: 上限 10 個標籤
- Q: 現有 shows 表的非正規化 tags[] 欄位要如何處理？ → A: 將 shows.tags[] 遷移至正規化 tags 表，建立 show_tags 關聯表
- Q: 刪除已被使用中的標籤時，是否需要二次確認？ → A: 顯示受影響的單集/節目數量，要求管理員確認後才刪除

## Background

目前 Tags 系統的資料庫層（`tags` 表、`episode_tags` 關聯表）和 RLS 安全政策已完備，單集詳情頁也能顯示標籤。但管理端缺乏標籤 CRUD 介面、單集無法指派標籤、搜尋過濾也沒有串接標籤 UI，導致整個標籤功能形同虛設。此 feature 旨在補齊所有缺失環節，讓標籤系統完整可用。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理員在後台管理標籤 (Priority: P1)

管理員需要在後台建立、編輯、刪除標籤，作為整個標籤系統的基礎。沒有標籤就無法進行後續的指派和過濾。

**Why this priority**: 標籤管理是所有標籤功能的前提，沒有可管理的標籤，其餘功能無法運作。

**Independent Test**: 管理員可在後台建立新標籤「科技」，編輯名稱為「科技新聞」，刪除後確認標籤不再出現於列表中。

**Acceptance Scenarios**:

1. **Given** 管理員已登入後台, **When** 點擊「新增標籤」並輸入名稱「科技」, **Then** 系統自動產生 slug 並成功建立標籤
2. **Given** 標籤「科技」已存在, **When** 管理員編輯名稱為「科技新聞」, **Then** 標籤名稱更新成功，slug 同步更新
3. **Given** 標籤「科技新聞」已存在, **When** 管理員刪除該標籤, **Then** 標籤被移除，所有相關的單集-標籤關聯也一併清除
4. **Given** 管理員嘗試建立已存在的標籤名稱, **When** 送出表單, **Then** 系統顯示「此標籤已存在」的錯誤訊息

---

### User Story 2 - 管理員為單集指派標籤 (Priority: P1)

管理員在編輯單集時，能從已建立的標籤中選取多個標籤指派給單集，或移除已指派的標籤。

**Why this priority**: 指派標籤是讓標籤對使用者可見的關鍵步驟，與標籤管理同為核心功能。

**Independent Test**: 管理員在編輯單集頁面，選取「科技」和「訪談」兩個標籤，儲存後在單集詳情頁確認標籤正確顯示。

**Acceptance Scenarios**:

1. **Given** 管理員在編輯單集頁面, **When** 在標籤選擇器中搜尋並選取「科技」, **Then** 「科技」被加入已選標籤列表
2. **Given** 單集已指派「科技」「訪談」標籤, **When** 管理員移除「訪談」並儲存, **Then** 單集只剩「科技」標籤
3. **Given** 管理員在標籤選擇器中輸入不存在的標籤名稱, **When** 找不到結果, **Then** 顯示「查無標籤」提示

---

### User Story 3 - 訪客透過標籤瀏覽相關單集 (Priority: P2)

訪客在單集詳情頁看到標籤後，可以點擊標籤查看所有具有相同標籤的單集列表。

**Why this priority**: 這是標籤對一般使用者最直接的價值——發現相關內容。

**Independent Test**: 訪客在某單集頁面點擊「#科技」標籤，跳轉至標籤頁面，看到所有標記為「科技」的單集。

**Acceptance Scenarios**:

1. **Given** 訪客在單集詳情頁看到「#科技」標籤, **When** 點擊該標籤, **Then** 跳轉至標籤結果頁面，列出所有標記為「科技」的單集
2. **Given** 標籤結果頁面有多筆單集, **When** 頁面載入, **Then** 單集以發布日期降冪排列，使用與節目頁面一致的 card grid 佈局
3. **Given** 某標籤下沒有任何單集, **When** 訪客造訪該標籤頁面, **Then** 顯示「此標籤下暫無單集」的空狀態提示

---

### User Story 4 - 訪客在搜尋時使用標籤過濾 (Priority: P3)

訪客在搜尋頁面可以透過標籤篩選，快速縮小搜尋結果範圍。

**Why this priority**: 進階搜尋功能，提升內容發現效率，但並非標籤系統的核心功能。

**Independent Test**: 訪客在搜尋頁面勾選「科技」標籤，確認搜尋結果僅包含具有該標籤的單集。

**Acceptance Scenarios**:

1. **Given** 訪客在搜尋頁面, **When** 展開標籤篩選並選取「科技」, **Then** 搜尋結果僅顯示具有「科技」標籤的單集
2. **Given** 訪客已選取「科技」標籤篩選, **When** 同時輸入關鍵字搜尋, **Then** 結果同時滿足關鍵字和標籤條件
3. **Given** 訪客選取某標籤篩選後無結果, **When** 頁面載入, **Then** 顯示「沒有符合條件的結果」並建議清除篩選

---

### Edge Cases

- 當管理員刪除一個已被多個單集使用的標籤時，所有關聯自動清除，受影響的單集頁面不再顯示該標籤
- 當兩個管理員同時建立相同名稱的標籤時，資料庫 unique 約束確保只有一個成功，另一個收到錯誤提示
- 當標籤名稱包含特殊字元（如 `#`、`&`、空格）時，slug 應正確處理為 URL-safe 格式
- 當單集被刪除時，相關的 episode_tags 記錄隨 CASCADE 刪除
- 當管理員嘗試為單集指派第 11 個標籤時，系統顯示已達上限提示，不允許新增
- 遷移 shows.tags[] 時，若標籤名稱在 tags 表中已存在則複用，不重複建立

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 管理員 MUST 能在後台建立新標籤（名稱、slug）
- **FR-002**: 管理員 MUST 能編輯已存在的標籤名稱和 slug
- **FR-003**: 管理員 MUST 能刪除標籤；刪除前須顯示受影響的單集與節目數量，經管理員確認後才執行刪除，相關關聯自動移除
- **FR-004**: 標籤名稱 MUST 具有唯一性，不允許重複建立
- **FR-005**: 管理員 MUST 能在編輯單集時，從已建立的標籤中選取並指派多個標籤（上限 10 個）
- **FR-006**: 管理員 MUST 能在編輯單集時，移除已指派的標籤
- **FR-007**: 單集詳情頁的標籤 MUST 可點擊，導向該標籤的單集列表頁
- **FR-008**: 標籤單集列表頁 MUST 顯示所有具有該標籤的已發布單集
- **FR-009**: 搜尋頁面 MUST 提供標籤篩選選項，與現有搜尋功能整合
- **FR-010**: 標籤篩選 MUST 支援同時選取多個標籤（聯集：符合任一即顯示）
- **FR-011**: 後台管理側邊欄 MUST 新增「標籤管理」入口
- **FR-012**: 現有 shows 表的非正規化 tags[] 欄位 MUST 遷移至正規化 tags 表，並建立 show_tags 關聯表
- **FR-013**: 管理員 MUST 能在編輯節目時，從已建立的標籤中選取並指派多個標籤（與單集標籤共用同一套 tags 表）

### Key Entities

- **Tag**: 標籤實體，具有名稱和 slug，用於分類和發現單集及節目內容
- **EpisodeTag**: 單集與標籤的多對多關聯，一個單集可有多個標籤（上限 10），一個標籤可對應多個單集
- **ShowTag**: 節目與標籤的多對多關聯（取代原 shows.tags[] 非正規化欄位），一個節目可有多個標籤，一個標籤可對應多個節目

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理員能在 30 秒內完成建立一個新標籤
- **SC-002**: 管理員能在編輯單集時 1 分鐘內完成標籤指派操作
- **SC-003**: 訪客點擊標籤後，在 2 秒內看到該標籤的相關單集列表
- **SC-004**: 搜尋頁面的標籤篩選能正確縮小結果範圍，過濾後的每筆結果都包含所選標籤

## Assumptions

- 標籤系統統一使用正規化 `tags` 表搭配 `episode_tags` 和新建的 `show_tags` 關聯表；shows.tags[] 欄位將在遷移完成後移除
- 標籤只由管理員管理，一般使用者無法建立或編輯標籤
- 標籤頁面使用與其他列表頁（如節目單集列表）一致的 card grid 佈局
- slug 自動從標籤名稱產生，管理員可手動修改
